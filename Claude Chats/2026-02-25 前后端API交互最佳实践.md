---
tags:
  - api
  - fastapi
  - orval
  - react-query
  - openapi
  - frontend
  - backend
---

## 背景

探讨前后端交互 API 接口的最佳实践，场景：C 端产品 + React/Next.js + 前后端分离。

## API 协议选型

| 架构 | 推荐方案 |
|------|---------|
| 全栈 / monorepo | **tRPC** — 端到端类型安全，开发效率最高 |
| 前后端分离（REST） | **OpenAPI + 代码生成（orval）** |
| 前后端分离（GraphQL） | **GraphQL + codegen** |

- tRPC 本质基于 HTTP，不是新协议，只是在 HTTP 上加了类型安全的 RPC 抽象
- tRPC 适合"自己既写前端又写后端"的场景，前后端分离用不上

## OpenAPI + orval 方案

### 核心流程

```
后端写接口 → 自动生成 OpenAPI spec → 前端跑 orval → 自动生成类型 + React Query hooks → 组件直接用
```

### orval 关键配置

- `client: 'react-query'` — 生成 React Query hooks
- `mode: 'tags-split'` — 按后端 API tag 拆分文件
- `override.mutator` — 自定义请求实例（统一处理 token、错误）
- `hooks.afterAllFilesWrite: 'prettier --write'` — 生成后自动格式化（需装 prettier）

### 注意事项

- 后端要设好 `operation_id`，否则生成的 hook 名很冗长（如 `useListUsersUsersGet`）
- 后端按模块分好 `tags`，前端生成的文件才会按模块拆分
- 生成的文件当黑盒用，不要手动改
- 每次 `pnpm orval` 是全量重新生成

## FastAPI

- Python 最流行的 API 框架，写类型注解就自动有 OpenAPI 文档 + 数据校验
- 对比 Django：FastAPI 轻量只管 API，Django 是全家桶（Admin、ORM、模板引擎）
- 前后端分离场景 FastAPI 更合适，Django 很多内置功能用不上
- 性能：Go > Node > FastAPI > Django，但大部分项目瓶颈在 DB 和网络 IO
- 如果需要 Admin 后台，可以用 **SQLAdmin**（FastAPI 版 Django Admin）
- 文档 UI 可以从默认 Swagger UI 换成 **Scalar**，更现代美观

### 各语言生成 OpenAPI 的方式

| 语言 | 框架/工具 | 额外工作量 |
|------|-----------|-----------|
| Python | FastAPI | 几乎为零，天生自带 |
| Node/TS | NestJS + @nestjs/swagger | 低，加装饰器 |
| Java | Spring Boot + springdoc | 低，加依赖 |
| Go | swaggo/swag | 低，写注释 |
| Rust | utoipa + Axum | 低，加宏 |
| PHP | Laravel + Scramble | 几乎为零，自动推断 |

## Demo 项目

搭建了完整 demo：`~/personal/fastapi-demo/`

- 后端：FastAPI + Scalar 文档 + CORS
- 前端：Next.js + orval + React Query
- 三个模块：user / order / product

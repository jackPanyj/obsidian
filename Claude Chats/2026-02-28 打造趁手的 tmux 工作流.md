---
tags:
  - tmux
  - cli
  - dotfiles
  - fzf
  - zoxide
  - workflow
---

这篇文章记录了我对 tmux 工作流的一次完整改造，解决了几个长期的痛点：窗口/session 命名不直观、session 管理不方便、重复创建 session 等问题。

## 问题

默认的 tmux 体验有几个不爽的地方：

1. **窗口名是程序名** — 状态栏显示 `zsh`、`node` 这些，切换窗口时不知道哪个窗口在干什么
2. **Session 名是数字** — 自动分配 0、1、2，完全看不出是哪个项目
3. **Session 管理靠手动** — 要 `tmux ls`、`tmux attach -t xxx`，很繁琐
4. **重复创建 session** — 同一个项目目录反复新建 session，越来越多

## 窗口自动命名为当前目录

第一个改动：让 tmux 窗口名自动跟随当前所在目录。

### 踩坑：`automatic-rename-format` 被插件覆盖

最初的想法是用 tmux 原生的 `automatic-rename`：

```bash
set -g automatic-rename on
set -g automatic-rename-format '#{b:pane_current_path}'
```

但我用了 catppuccin 主题插件，它通过 TPM 加载后会重设窗口格式。配置里的 `#W`（窗口名变量）被覆盖回默认值，导致设置无效。

### 解决：直接在 catppuccin 模板里用路径变量

绕过 `#W`，在 catppuccin 的窗口文本配置里直接使用 `#{b:pane_current_path}`：

```bash
# tmux.conf
set -g automatic-rename on
set -g automatic-rename-format '#{b:pane_current_path}'

# catppuccin theme — 直接用路径变量，不依赖 #W
set -g @catppuccin_window_default_text ' #{b:pane_current_path}'
set -g @catppuccin_window_current_text ' #{b:pane_current_path}'
```

`#{b:pane_current_path}` 中的 `b:` 是 tmux 的 basename 修饰符，取路径最后一级目录名。这样窗口名直接显示 `manic-trade-web`、`obsidian` 这种可读名称。

## Session 自动命名为完整路径

窗口解决了，接下来是 session。目标是：

- Session 名用完整路径（带 `~` 前缀），方便区分同名目录
- 同一目录不重复创建 session

### 踩坑一：tmux hook 引号嵌套

最初想用 `set-hook` 在 session 创建时自动重命名：

```bash
set-hook -g session-created 'if -F "#{m/r:^[0-9]+$,#{session_name}}" "rename-session #{b:pane_current_path}" ""'
```

结果 hook 注册了，但命令体是空的。原因是 tmux 解析嵌套引号时，外层单引号内的双引号把命令吞掉了。改成外层双引号、内层单引号可以修复解析问题。

### 踩坑二：`session-created` 时 pane 未初始化

即使引号问题修好了，`rename-session #{b:pane_current_path}` 仍然报 "too few arguments"。原因是 `session-created` 钩子触发时，pane 还没完全初始化，`#{b:pane_current_path}` 解析为空字符串。

用 `run-shell` + `sleep` 也不行——tmux 的 `run-shell` 会在执行前先展开所有格式变量，sleep 延迟的只是 shell 命令的执行，变量早就被展开成空值了。

### 最终方案：放到 zshrc 里

放弃 tmux hook，把逻辑移到 `~/.zshrc`。zsh 启动时 pane 已经完全初始化，`$PWD` 一定有值：

```zsh
# ~/.zshrc 顶部
if [[ -n "$TMUX" ]]; then
  _tmux_s=$(tmux display-message -p '#S')
  if [[ "$_tmux_s" =~ ^[0-9]+$ ]]; then
    _tmux_path="${PWD/#$HOME/~}"
    if tmux has-session -t "=$_tmux_path" 2>/dev/null; then
      # session for this path already exists, switch to it and kill the new one
      tmux switch-client -t "=$_tmux_path"
      tmux kill-session -t "$_tmux_s"
    else
      tmux rename-session "$_tmux_path"
    fi
  fi
  unset _tmux_s _tmux_path
fi
```

逻辑：

1. 检测是否在 tmux 内
2. 获取当前 session 名，如果是纯数字（tmux 自动分配的）才处理
3. 用 `${PWD/#$HOME/~}` 把 home 路径替换成 `~`，生成类似 `~/sonic/manic-trade-web` 的名称
4. 如果已有同名 session → 直接切过去，关掉新建的那个
5. 否则 → 重命名当前 session

> **注意**：`\~` 和 `~` 的区别。zsh 的参数替换中 `\~` 会产生字面反斜杠，导致 session 名变成 `\~/path`，tmux 匹配时会出问题。要用 `~`（不转义）。

## `tm` — fzf 驱动的 session 管理器

解决了命名问题后，还需要一个好用的 session 管理器。写了一个 `tm` 函数，用 fzf 做交互式界面：

```zsh
tm() {
  # If tmux server not running, start a new session directly
  if ! tmux ls &>/dev/null; then
    tmux new-session
    return
  fi

  local sep="│"
  local header="ctrl-d: kill session"

  # Build list: existing sessions first, then zoxide dirs
  local list
  list=$(
    tmux ls -F "#{session_name}${sep}#{session_path}${sep}#{session_windows} wins" 2>/dev/null
    local existing
    existing=$(tmux ls -F '#{session_path}' 2>/dev/null)
    zoxide query -l 2>/dev/null | while read -r dir; do
      echo "$existing" | /usr/bin/grep -qxF "$dir" || echo "new${sep}${dir}${sep}"
    done
  )

  [[ -z "$list" ]] && { echo "No sessions or zoxide dirs found"; return 1; }

  local sel
  sel=$(echo "$list" | fzf \
    --height=50% --reverse \
    --prompt='tmux> ' \
    --header="$header" \
    --delimiter="$sep" \
    --with-nth=1,2 \
    --bind="ctrl-d:execute-silent(tmux kill-session -t {1} 2>/dev/null)+reload(tmux ls -F '#{session_name}${sep}#{session_path}${sep}#{session_windows} wins' 2>/dev/null)" \
    --preview='
      name=$(echo {} | cut -d"'"$sep"'" -f1)
      if [ "$name" != "new" ]; then
        tmux capture-pane -t "$name" -p 2>/dev/null || echo "Session: $name"
      else
        dir=$(echo {} | cut -d"'"$sep"'" -f2)
        eza --color=always "$dir" 2>/dev/null || ls "$dir"
      fi
    ' \
    --preview-window=right:50%
  ) || return 0

  local name dir
  name=$(echo "$sel" | cut -d"$sep" -f1)
  dir=$(echo "$sel" | cut -d"$sep" -f2)

  if [[ "$name" == "new" ]]; then
    local session_name="${dir/#$HOME/~}"
    if tmux has-session -t "=$session_name" 2>/dev/null; then
      tmux switch-client -t "=$session_name" 2>/dev/null || tmux attach -t "=$session_name"
    else
      tmux new-session -d -s "$session_name" -c "$dir"
      tmux switch-client -t "=$session_name" 2>/dev/null || tmux attach -t "=$session_name"
    fi
  else
    tmux switch-client -t "=$name" 2>/dev/null || tmux attach -t "=$name"
  fi
}
```

### 数据源

列表数据来自两处：

- **已有 session** — `tmux ls` 输出，包含 session 名、路径、窗口数
- **常用目录** — `zoxide query -l`，按访问频率排序。已有 session 对应的目录会被过滤掉，避免重复

zoxide 会记录你 `cd` 去过的所有目录并按频率排序，所以 `tm` 用得越多，目录列表就越精准。

### 功能

| 操作 | 效果 |
|------|------|
| 选择已有 session | 切换/连接到该 session |
| 选择 zoxide 目录 | 新建 session（同路径已有则复用） |
| `ctrl-d` | 删除选中的 session，列表自动刷新 |
| tmux 没启动时执行 `tm` | 直接新建 session |

### 预览面板

fzf 右侧的预览面板会根据选中项类型显示不同内容：

- **已有 session** — 显示当前 pane 的内容（`tmux capture-pane`）
- **目录** — 显示文件列表（`eza`）

### fzf 的关键特性

`tm` 的交互能力完全依赖 fzf 提供：

- `--preview` — 右侧预览面板
- `--bind="ctrl-d:execute-silent(...)+reload(...)"` — 快捷键触发动作后刷新列表
- `--delimiter` + `--with-nth` — 控制显示哪些列（隐藏内部标记）
- `--header` — 顶部显示快捷键提示

fzf 本质上是一个小型 TUI 框架，配合 shell 管道可以做出各种交互式工具。

## 完整配置

最终涉及两个文件：

### `~/.config/tmux/tmux.conf`（相关部分）

```bash
# Window auto rename to current directory
set -g automatic-rename on
set -g automatic-rename-format '#{b:pane_current_path}'

# catppuccin — use path variable directly, bypass #W
set -g @catppuccin_window_default_text ' #{b:pane_current_path}'
set -g @catppuccin_window_current_text ' #{b:pane_current_path}'
```

### `~/.zshrc`（相关部分）

```zsh
# Auto-rename tmux session + reuse existing
if [[ -n "$TMUX" ]]; then
  _tmux_s=$(tmux display-message -p '#S')
  if [[ "$_tmux_s" =~ ^[0-9]+$ ]]; then
    _tmux_path="${PWD/#$HOME/~}"
    if tmux has-session -t "=$_tmux_path" 2>/dev/null; then
      tmux switch-client -t "=$_tmux_path"
      tmux kill-session -t "$_tmux_s"
    else
      tmux rename-session "$_tmux_path"
    fi
  fi
  unset _tmux_s _tmux_path
fi

# tm — fzf session manager (replaces raw tmux command)
tm() { ... }  # see full code above
```

## 总结

这套方案不依赖任何额外的 tmux 插件（如 tmux-sessionizer 或 sesh），纯粹用 zsh + fzf + zoxide 组合实现：

- **窗口名** — 自动显示当前目录 basename
- **Session 名** — 自动命名为完整路径（`~/project/path`）
- **Session 复用** — 同一目录不会重复创建
- **`tm` 命令** — 一键管理所有 session，完全替代 `tmux` 命令

整个改造过程踩了不少坑（tmux hook 引号、格式变量展开时机、zsh 转义字符），最终发现很多时候把逻辑放在 shell 层面比 tmux 原生机制更可靠。

## 快速上手

想直接用这套方案？按下面的步骤操作。

### 安装依赖

需要 4 个工具，`eza` 可选（有 `ls` 兜底）：

```bash
# macOS (Homebrew)
brew install tmux fzf zoxide eza

# Ubuntu / Debian
sudo apt install tmux fzf
# zoxide 和 eza 需要手动安装，参考各自 GitHub README：
# https://github.com/ajeetdsouza/zoxide
# https://github.com/eza-community/eza

# Arch Linux
sudo pacman -S tmux fzf zoxide eza
```

确保 zoxide 已初始化（加到 `~/.zshrc` 或 `~/.bashrc`）：

```bash
eval "$(zoxide init zsh)"   # zsh
eval "$(zoxide init bash)"  # bash
```

### 配置 tmux

在 `~/.tmux.conf`（或 `~/.config/tmux/tmux.conf`）中添加：

```bash
# Window auto rename to current directory
set -g automatic-rename on
set -g automatic-rename-format '#{b:pane_current_path}'
```

如果你用了 catppuccin 主题，还需要加上（否则会被插件覆盖）：

```bash
set -g @catppuccin_window_default_text ' #{b:pane_current_path}'
set -g @catppuccin_window_current_text ' #{b:pane_current_path}'
```

### 配置 shell

将以下代码添加到 `~/.zshrc`（bash 用户放 `~/.bashrc`，语法需微调）：

```zsh
# ── Auto-rename tmux session to current directory path ─────
# When a new tmux session has a numeric name (auto-assigned),
# rename it to the current directory. Reuse existing session
# if one already exists for the same path.
if [[ -n "$TMUX" ]]; then
  _tmux_s=$(tmux display-message -p '#S')
  if [[ "$_tmux_s" =~ ^[0-9]+$ ]]; then
    _tmux_path="${PWD/#$HOME/~}"
    if tmux has-session -t "=$_tmux_path" 2>/dev/null; then
      tmux switch-client -t "=$_tmux_path"
      tmux kill-session -t "$_tmux_s"
    else
      tmux rename-session "$_tmux_path"
    fi
  fi
  unset _tmux_s _tmux_path
fi

# ── tm: fzf-powered tmux session manager ──────────────────
# Usage: tm
# - Lists existing sessions + frequently visited directories (via zoxide)
# - Select a session to switch/attach, or a directory to create a new session
# - ctrl-d to kill a session from the list
tm() {
  if ! tmux ls &>/dev/null; then
    tmux new-session
    return
  fi

  local sep="│"
  local header="ctrl-d: kill session"

  local list
  list=$(
    tmux ls -F "#{session_name}${sep}#{session_path}${sep}#{session_windows} wins" 2>/dev/null
    local existing
    existing=$(tmux ls -F '#{session_path}' 2>/dev/null)
    zoxide query -l 2>/dev/null | while read -r dir; do
      echo "$existing" | command grep -qxF "$dir" || echo "new${sep}${dir}${sep}"
    done
  )

  [[ -z "$list" ]] && { echo "No sessions or zoxide dirs found"; return 1; }

  local sel
  sel=$(echo "$list" | fzf \
    --height=50% --reverse \
    --prompt='tmux> ' \
    --header="$header" \
    --delimiter="$sep" \
    --with-nth=1,2 \
    --bind="ctrl-d:execute-silent(tmux kill-session -t {1} 2>/dev/null)+reload(tmux ls -F '#{session_name}${sep}#{session_path}${sep}#{session_windows} wins' 2>/dev/null)" \
    --preview='
      name=$(echo {} | cut -d"'"$sep"'" -f1)
      if [ "$name" != "new" ]; then
        tmux capture-pane -t "$name" -p 2>/dev/null || echo "Session: $name"
      else
        dir=$(echo {} | cut -d"'"$sep"'" -f2)
        eza --color=always "$dir" 2>/dev/null || ls "$dir"
      fi
    ' \
    --preview-window=right:50%
  ) || return 0

  local name dir
  name=$(echo "$sel" | cut -d"$sep" -f1)
  dir=$(echo "$sel" | cut -d"$sep" -f2)

  if [[ "$name" == "new" ]]; then
    local session_name="${dir/#$HOME/~}"
    if tmux has-session -t "=$session_name" 2>/dev/null; then
      tmux switch-client -t "=$session_name" 2>/dev/null || tmux attach -t "=$session_name"
    else
      tmux new-session -d -s "$session_name" -c "$dir"
      tmux switch-client -t "=$session_name" 2>/dev/null || tmux attach -t "=$session_name"
    fi
  else
    tmux switch-client -t "=$name" 2>/dev/null || tmux attach -t "=$name"
  fi
}
```

重新加载配置：

```bash
source ~/.zshrc
tmux source-file ~/.tmux.conf  # if inside tmux
```

现在输入 `tm` 就可以开始使用了。
